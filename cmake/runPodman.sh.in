#!/bin/sh

set -e
set -x
echo "do we need to run podman here at all???"
TWEAK="$1"

AUTH=@CMAKE_BINARY_DIR@/podman-authentication
A=$(jq -r ".auths.\"@PODMAN_REGISTRY@\".auth" $AUTH || echo "")

if [ "@DEVELOPER_ROLE@" = "developer" ]; then
    ANON="anonymous"
    
    if ! echo "$A" | base64 -d | sed 's/\(.*\):.*/\1/' | grep "$ANON" > /dev/null; then
        podman login --tls-verify=false --authfile=$AUTH --username $ANON --password $ANON @PODMAN_REGISTRY@
    fi

    if ! podman image exists @PODMAN_REGISTRY@/generic:@DOCKERFILE_SHA1@; then
        echo "*******************************************************"
        echo "*******************************************************"
        echo "*******************************************************"
        echo "If you changed pods or dependent files, you have to"
        echo "change the role to 'pod-maintainer' in order to push"
        echo "to nonlinear labs podman registry."
        echo "> 'cmake -DDEVELOPER_ROLE=pod-maintainer -DPODMAN_REGISTRY_PASSWORD=xxxxxxxx .'"
        echo "*******************************************************"
        echo "*******************************************************"
        echo "*******************************************************"
        exit  1
    fi
fi

if [ "@DEVELOPER_ROLE@" = "pod-maintainer" ]; then
    if ! echo "$A" | base64 -d | sed 's/\(.*\):.*/\1/' | grep "nonlinearlabs" > /dev/null; then
        podman login --tls-verify=false --authfile=$AUTH --username "nonlinearlabs" --password "@PODMAN_REGISTRY_PASSWORD@" @PODMAN_REGISTRY@
    fi

    if ! podman image exists @PODMAN_REGISTRY@/generic:@DOCKERFILE_SHA1@; then
        if [ -f $TWEAK ]; then
            podman container rm intermediate-@DOCKERFILE_SHA1@ || true
            podman build -t @PODMAN_REGISTRY@/intermediate:@DOCKERFILE_SHA1@ .
            podman run -ti --privileged -v $TWEAK:/tweak.sh --name intermediate-@DOCKERFILE_SHA1@ --tls-verify=false --authfile=$AUTH @PODMAN_REGISTRY@/intermediate:@DOCKERFILE_SHA1@ /tweak.sh
            podman commit --include-volumes intermediate-@DOCKERFILE_SHA1@ @PODMAN_REGISTRY@/generic:@DOCKERFILE_SHA1@
            podman container rm intermediate-@DOCKERFILE_SHA1@
        else
            podman build -t @PODMAN_REGISTRY@/generic:@DOCKERFILE_SHA1@ .
            podman push --tls-verify=false --authfile=$AUTH generic:@DOCKERFILE_SHA1@ @PODMAN_REGISTRY@/generic:@DOCKERFILE_SHA1@        
        fi
    fi
fi

